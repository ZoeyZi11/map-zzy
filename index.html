<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…è¡Œè¶³è¿¹ - å®Œç¾ä¿®å¤ç‰ˆ</title>
    
    <script src="https://assets.pyecharts.org/assets/echarts.min.js"></script>
    <script src="https://assets.pyecharts.org/assets/maps/china.js"></script>
    <script src="https://assets.pyecharts.org/assets/maps/world.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Microsoft YaHei', sans-serif; background-color: #ffffff; }
        
        .header {
            background: #fff; 
            padding: 15px; 
            text-align: center;
            border-bottom: 1px solid #eee;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        h1 { margin: 0 0 10px 0; font-size: 24px; color: #333; letter-spacing: 1px; }
        
        .controls button {
            padding: 8px 25px; margin: 0 5px; cursor: pointer;
            border: 1px solid #333; background: #fff; color: #333; 
            border-radius: 4px; font-size: 14px; transition: 0.3s;
        }
        .controls button:hover { background: #f0f0f0; }
        .controls button.active { background: #333; color: #fff; }
        
        .tools { margin-top: 15px; font-size: 14px; color: #666; display: flex; justify-content: center; gap: 15px; align-items: center;}
        
        /* çº¢è‰²ä¿å­˜æŒ‰é’® */
        .save-btn {
            background-color: #d9534f !important; border-color: #d9534f !important; color: white !important;
        }
        .save-btn:hover { background-color: #c9302c !important; }

        #map-container { width: 100%; height: calc(100vh - 140px); }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ—ºï¸ æˆ‘çš„æ—…è¡Œè¶³è¿¹</h1>
    <div class="controls">
        <button id="btn-china" class="active" onclick="initMap('china')">ğŸ‡¨ğŸ‡³ å›½å†…</button>
        <button id="btn-world" onclick="initMap('world')">ğŸŒ ä¸–ç•Œ</button>
    </div>
    <div class="tools">
        <span>å·²ç‚¹äº®: <strong id="count" style="color:#d9534f; font-size:18px;">0</strong> å¤„</span>
        <a href="#" onclick="clearData(); return false;" style="color:#999; text-decoration:none;">[æ¸…ç©º]</a>
        <button class="save-btn" onclick="saveMapImage()">ğŸ“· ä¿å­˜å›¾ç‰‡</button>
    </div>
</div>

<div id="map-container"></div>

<script>
    var myChart = echarts.init(document.getElementById('map-container'));
    var currentMode = 'china';
    var visitedData = { china: [], world: [] };

    // è¯»å–ç¼“å­˜
    try {
        var saved = localStorage.getItem('my_footprint_v5'); // å‡çº§ç‰ˆæœ¬å·ä»¥é˜²ç¼“å­˜å†²çª
        if (saved) visitedData = JSON.parse(saved);
    } catch(e) {}

    // å¯åŠ¨
    initMap('china');

    function initMap(mapType) {
        currentMode = mapType;
        
        // æ›´æ–°æŒ‰é’®UI
        document.getElementById('btn-china').className = mapType === 'china' ? 'active' : '';
        document.getElementById('btn-world').className = mapType === 'world' ? 'active' : '';

        // æ„é€ æ•°æ®ï¼šå»è¿‡çš„åœ°æ–¹ value=1
        var dataList = visitedData[mapType].map(function(name) {
            return { name: name, value: 1 };
        });

        var option = {
            backgroundColor: '#ffffff', // èƒŒæ™¯çº¯ç™½
            
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    // æç¤ºæ¡†é€»è¾‘
                    if (params.value === 1) return params.name + ' (å·²å»è¿‡)';
                    return params.name;
                }
            },

            // ğŸŒŸ æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ VisualMap å¼ºåˆ¶æ§åˆ¶é¢œè‰²
            // é€»è¾‘ï¼šæœ‰æ•°å€¼(1)çš„æ˜¾ç¤ºçº¢è‰²ï¼Œæ²¡æœ‰æ•°å€¼(NaN)çš„æ˜¾ç¤ºé»˜è®¤ç™½è‰²
            visualMap: {
                show: false, // ä¸æ˜¾ç¤ºå·¦ä¸‹è§’çš„è‰²æ¡
                min: 0,
                max: 1,
                pieces: [
                    { value: 1, color: '#ff5252' } // åªæœ‰ value=1 çš„æ‰å˜çº¢
                ],
                outOfRange: {
                    color: '#ffffff' // æ²¡æ•°æ®çš„å…¨éƒ¨ç™½è‰²
                }
            },

            series: [{
                type: 'map',
                map: mapType,
                roam: true, // å…è®¸ç¼©æ”¾
                zoom: 1.2,
                
                // é»˜è®¤æ ·å¼ï¼ˆæ²¡å»è¿‡çš„åœ°æ–¹çš„è¾¹æ¡†ï¼‰
                itemStyle: {
                    areaColor: '#ffffff',
                    borderColor: '#999',
                    borderWidth: 0.5
                },
                
                // é¼ æ ‡æ‚¬åœé«˜äº®æ ·å¼
                emphasis: {
                    itemStyle: {
                        areaColor: '#ffe082' // é»„è‰²é«˜äº®
                    },
                    label: {
                        show: true // åªæœ‰é¼ æ ‡æ”¾ä¸Šå»æ‰æ˜¾ç¤ºåå­—ï¼Œä¿æŒç•Œé¢å¹²å‡€
                    }
                },
                
                // æ³¨å…¥æ•°æ®
                data: dataList,

                // ä¸–ç•Œåœ°å›¾åç§°ä¿®æ­£æ˜ å°„
                nameMap: mapType === 'world' ? {
                    'United States': 'United States of America'
                } : {}
            }]
        };

        myChart.setOption(option, true); // trueè¡¨ç¤ºå½»åº•é‡ç»˜ï¼Œé˜²æ­¢æ®‹ç•™
        updateCount();

        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        myChart.off('click');
        myChart.on('click', function(params) {
            if (params.name) {
                toggleVisit(params.name);
            }
        });
    }

    function toggleVisit(name) {
        var list = visitedData[currentMode];
        var index = list.indexOf(name);
        
        if (index > -1) {
            list.splice(index, 1); // å†æ¬¡ç‚¹å‡»ï¼Œå–æ¶ˆ
        } else {
            list.push(name); // é¦–æ¬¡ç‚¹å‡»ï¼Œæ·»åŠ 
        }
        
        // ä¿å­˜å¹¶åˆ·æ–°
        localStorage.setItem('my_footprint_v5', JSON.stringify(visitedData));
        initMap(currentMode);
    }

    function updateCount() {
        document.getElementById('count').innerText = visitedData[currentMode].length;
    }
    
    function clearData() {
        if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Ÿ')) {
            visitedData[currentMode] = [];
            localStorage.setItem('my_footprint_v5', JSON.stringify(visitedData));
            initMap(currentMode);
        }
    }

    function saveMapImage() {
        var url = myChart.getDataURL({
            type: 'png',
            pixelRatio: 2, // é«˜æ¸…
            backgroundColor: '#fff',
            excludeComponents: ['toolbox']
        });
        var a = document.createElement('a');
        a.download = 'æˆ‘çš„è¶³è¿¹_' + currentMode + '.png';
        a.href = url;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    window.onresize = function() { myChart.resize(); };
</script>
</body>
</html>
