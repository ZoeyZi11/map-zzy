<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…è¡Œå£è¢‹</title>
    <script src="https://assets.pyecharts.org/assets/echarts.min.js"></script>
    <script src="https://assets.pyecharts.org/assets/maps/china.js"></script>
    <script src="https://assets.pyecharts.org/assets/maps/world.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #F0F5FA;
            --bg-card: #FFFFFF;
            --accent: #DDEEFF;
            --blue: #3A87C8;
            --blue-light: #7BB8E8;
            --blue-hover: #2E70AA;
            --text-primary: #1E2D3D;
            --text-secondary: #607D8B;
            --text-light: #B0BEC5;
            --border: #E0EAF2;
            --shadow: rgba(30,80,140,0.07);
            --header-h: 56px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* â•â•â• HEADER â•â•â• */
        .header {
            background: var(--bg-card);
            height: var(--header-h);
            padding: 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 8px var(--shadow);
            flex-shrink: 0;
            z-index: 10;
        }

        .logo {
            font-family: 'Noto Serif SC', serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 1px;
            flex-shrink: 0;
        }
        .logo span { color: var(--blue); }

        .divider {
            width: 1px; height: 20px;
            background: var(--border);
            flex-shrink: 0;
        }

        .tab-switch {
            display: flex;
            background: var(--bg);
            border-radius: 16px;
            padding: 3px;
            gap: 2px;
            flex-shrink: 0;
        }
        .tab-switch button {
            padding: 4px 12px;
            border: none;
            background: transparent;
            border-radius: 13px;
            font-size: 12px;
            font-family: 'Noto Sans SC', sans-serif;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            white-space: nowrap;
        }
        .tab-switch button.active {
            background: var(--bg-card);
            color: var(--blue);
            box-shadow: 0 1px 4px var(--shadow);
            font-weight: 500;
        }

        .header-spacer { flex: 1; min-width: 4px; }

        .stat-pill {
            background: var(--accent);
            border-radius: 14px;
            padding: 4px 10px;
            font-size: 12px;
            color: var(--blue);
            font-weight: 500;
            flex-shrink: 0;
            white-space: nowrap;
        }
        .stat-pill strong { font-size: 14px; }

        .header-actions { display: flex; gap: 6px; flex-shrink: 0; }

        .icon-btn {
            width: 32px; height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            cursor: pointer;
            font-size: 15px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary);
            transition: 0.2s;
            flex-shrink: 0;
        }
        .icon-btn:hover { background: var(--bg); }
        .icon-btn.primary { background: var(--blue); color: #fff; border-color: var(--blue); }
        .icon-btn.primary:hover { background: var(--blue-hover); }

        /* â•â•â• MAP â•â•â• */
        #map-container { flex: 1; width: 100%; min-height: 0; }

        /* â•â•â• OVERLAY â•â•â• */
        .overlay {
            display: none;
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.45);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 100;
        }
        .overlay.active { display: flex; align-items: flex-end; justify-content: center; }

        @media (min-width: 600px) {
            .overlay.active { align-items: center; }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* â•â•â• MODAL â•â•â• */
        .modal {
            background: var(--bg-card);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -8px 40px rgba(0,0,0,0.15);
            width: 100%;
            max-height: 92vh;
            max-height: 92dvh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            animation: slideUp 0.3s cubic-bezier(0.34,1.1,0.64,1);
        }

        @media (min-width: 600px) {
            .modal {
                border-radius: 16px;
                width: 90%;
                max-width: 540px;
                max-height: 88vh;
            }
            .memory-modal { max-width: 620px; }
        }

        /* æ‹–æ‹½æ¡ */
        .drag-handle {
            width: 36px; height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 10px auto 0;
        }
        @media (min-width: 600px) { .drag-handle { display: none; } }

        .modal-header {
            padding: 16px 20px 14px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky; top: 0;
            background: var(--bg-card);
            z-index: 1;
        }
        .modal-title {
            font-family: 'Noto Serif SC', serif;
            font-size: 17px; font-weight: 600;
        }
        .modal-subtitle { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

        .close-btn {
            width: 28px; height: 28px;
            border: none; background: var(--bg);
            border-radius: 50%; font-size: 14px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); transition: 0.2s; flex-shrink: 0;
        }
        .close-btn:hover { background: var(--border); }

        .modal-body { padding: 16px 20px; }

        /* â•â•â• FORM â•â•â• */
        .form-section { margin-bottom: 18px; }
        .form-label {
            font-size: 13px; font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex; align-items: center; gap: 4px;
        }
        .required-dot {
            width: 5px; height: 5px;
            background: var(--blue); border-radius: 50%;
            display: inline-block; flex-shrink: 0;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .photo-slot {
            aspect-ratio: 1;
            border-radius: 10px;
            border: 1.5px dashed var(--border);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; position: relative;
            background: var(--bg); transition: 0.2s;
        }
        .photo-slot:active { background: var(--accent); }
        .photo-slot.filled { border-style: solid; border-color: var(--border); }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; }
        .photo-slot .add-icon { font-size: 22px; color: var(--text-light); }
        .photo-slot .remove-photo {
            position: absolute; top: 4px; right: 4px;
            width: 22px; height: 22px;
            background: rgba(0,0,0,0.55); border-radius: 50%;
            border: none; color: white; font-size: 11px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .photo-hint { font-size: 11px; color: var(--text-light); margin-top: 6px; }

        .date-input {
            width: 100%; padding: 11px 12px;
            border: 1.5px solid var(--border); border-radius: 10px;
            font-size: 15px; font-family: 'Noto Sans SC', sans-serif;
            color: var(--text-primary); background: var(--bg);
            outline: none; transition: 0.2s; -webkit-appearance: none;
        }
        .date-input:focus { border-color: var(--blue); background: #fff; }

        .notes-textarea {
            width: 100%; padding: 11px 12px;
            border: 1.5px solid var(--border); border-radius: 10px;
            font-size: 14px; font-family: 'Noto Sans SC', sans-serif;
            color: var(--text-primary); background: var(--bg);
            outline: none; resize: none; height: 80px; transition: 0.2s;
        }
        .notes-textarea:focus { border-color: var(--blue); background: #fff; }
        .char-count { font-size: 11px; color: var(--text-light); text-align: right; margin-top: 4px; }

        .emoji-picker { margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
        .emoji-label { font-size: 11px; color: var(--text-light); }
        .emoji-btn {
            width: 32px; height: 32px;
            background: var(--bg); border: 1px solid var(--border);
            border-radius: 8px; cursor: pointer; font-size: 17px;
            display: flex; align-items: center; justify-content: center;
        }
        .emoji-btn:active { background: var(--accent); }

        .modal-footer {
            padding: 12px 20px 20px;
            border-top: 1px solid var(--border);
            display: flex; gap: 10px;
        }
        .modal-footer .btn { flex: 1; }

        .btn {
            padding: 12px 16px; border-radius: 10px; border: none;
            font-size: 14px; font-family: 'Noto Sans SC', sans-serif;
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            font-weight: 500;
        }
        .btn-ghost { background: var(--bg); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-primary { background: var(--blue); color: #fff; }
        .btn-primary:active { background: var(--blue-hover); }

        /* â•â•â• MEMORY CARDS â•â•â• */
        .memories-list { display: flex; flex-direction: column; gap: 14px; }

        .memory-card { background: var(--bg); border-radius: 12px; padding: 14px; }
        .memory-card-header {
            display: flex; align-items: center;
            justify-content: space-between; margin-bottom: 10px;
        }
        .memory-date {
            font-size: 12px; color: var(--blue); font-weight: 500;
            background: var(--accent); padding: 3px 10px; border-radius: 10px;
        }
        .memory-action-btn {
            padding: 4px 12px; font-size: 12px; border-radius: 6px;
            border: 1px solid var(--border); background: var(--bg-card);
            cursor: pointer; color: var(--text-secondary);
        }
        .memory-action-btn.del:active { background: #FFEBEE; color: #d32f2f; }

        .memory-photos {
            display: grid; grid-template-columns: repeat(3,1fr);
            gap: 6px; margin-bottom: 10px;
        }
        .memory-photos img {
            width: 100%; aspect-ratio: 1; object-fit: cover;
            border-radius: 8px; cursor: pointer;
        }
        .memory-note { font-size: 13px; color: var(--text-secondary); line-height: 1.7; }

        .empty-state { text-align: center; padding: 36px 20px; color: var(--text-light); }
        .empty-state .empty-icon { font-size: 44px; margin-bottom: 10px; }
        .empty-state p { font-size: 14px; }

        .add-memory-bar { padding: 0 20px 20px; }
        .add-memory-bar .btn { width: 100%; }

        /* â•â•â• LIGHTBOX â•â•â• */
        .lightbox {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.92); z-index: 200;
            align-items: center; justify-content: center;
        }
        .lightbox.active { display: flex; }
        .lightbox img { max-width: 96vw; max-height: 90vh; border-radius: 4px; object-fit: contain; }
        .lightbox-close { position: fixed; top: 16px; right: 20px; color: white; font-size: 28px; cursor: pointer; padding: 6px; }

        /* â•â•â• TOOLTIP â•â•â• */
        .region-tooltip {
            position: fixed;
            background: rgba(30,45,61,0.88); color: #fff;
            padding: 5px 12px; border-radius: 20px; font-size: 12px;
            pointer-events: none; z-index: 50; display: none;
            backdrop-filter: blur(4px);
        }
        @media (max-width: 599px) {
            .region-tooltip {
                left: 50% !important;
                top: calc(var(--header-h) + 10px) !important;
                transform: translateX(-50%);
                font-size: 13px; padding: 6px 16px;
            }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">æ—…è¡Œ<span>å£è¢‹</span></div>
    <div class="divider"></div>
    <div class="tab-switch">
        <button id="btn-china" class="active" onclick="initMap('china')">ğŸ‡¨ğŸ‡³ ä¸­å›½</button>
        <button id="btn-world" onclick="initMap('world')">ğŸŒ ä¸–ç•Œ</button>
    </div>
    <div class="header-spacer"></div>
    <div class="stat-pill">å·²ç‚¹äº® <strong id="count">0</strong> å¤„</div>
    <div class="header-actions">
        <button class="icon-btn" onclick="clearData()" title="æ¸…ç©º">ğŸ—‘</button>
        <button class="icon-btn primary" onclick="saveMapImage()" title="ä¿å­˜å›¾ç‰‡">ğŸ“·</button>
    </div>
</div>

<div id="map-container"></div>
<div class="region-tooltip" id="regionTooltip"></div>

<!-- æ·»åŠ å›å¿† -->
<div class="overlay" id="uploadOverlay">
    <div class="modal">
        <div class="drag-handle"></div>
        <div class="modal-header">
            <div>
                <div class="modal-title">âœˆï¸ æ·»åŠ æ—…è¡Œå›å¿†</div>
                <div class="modal-subtitle" id="uploadRegionName"></div>
            </div>
            <button class="close-btn" onclick="closeUpload()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="form-section">
                <div class="form-label">æ—…è¡Œç…§ç‰‡ <span class="required-dot"></span></div>
                <div class="photo-grid" id="photoGrid"></div>
                <div class="photo-hint">æ”¯æŒ JPG/PNGï¼Œå•å¼  â‰¤ 5MBï¼Œæœ€å¤š 9 å¼ </div>
                <input type="file" id="photoInput" accept="image/jpeg,image/png" multiple style="display:none" onchange="handlePhotoSelect(event)">
            </div>
            <div class="form-section">
                <div class="form-label">æ—…è¡Œæ—¶é—´ <span class="required-dot"></span></div>
                <input type="date" class="date-input" id="travelDate">
            </div>
            <div class="form-section">
                <div class="form-label">æ—…è¡Œå¤‡æ³¨ <span style="color:var(--text-light);font-weight:400;font-size:12px">ï¼ˆé€‰å¡«ï¼Œ100å­—å†…ï¼‰</span></div>
                <textarea class="notes-textarea" id="travelNote" placeholder="è®°å½•æ—…é€”ä¸­çš„æ•…äº‹..." maxlength="100" oninput="updateCharCount()"></textarea>
                <div class="char-count"><span id="charCount">0</span> / 100</div>
                <div class="emoji-picker">
                    <span class="emoji-label">å¿«é€Ÿæ’å…¥ï¼š</span>
                    <button class="emoji-btn" onclick="insertEmoji('â¤ï¸')">â¤ï¸</button>
                    <button class="emoji-btn" onclick="insertEmoji('ğŸŒŸ')">ğŸŒŸ</button>
                    <button class="emoji-btn" onclick="insertEmoji('ğŸ‰')">ğŸ‰</button>
                    <button class="emoji-btn" onclick="insertEmoji('ğŸœ')">ğŸœ</button>
                    <button class="emoji-btn" onclick="insertEmoji('ğŸ”ï¸')">ğŸ”ï¸</button>
                    <button class="emoji-btn" onclick="insertEmoji('ğŸŒŠ')">ğŸŒŠ</button>
                    <button class="emoji-btn" onclick="insertEmoji('ğŸŒ¸')">ğŸŒ¸</button>
                    <button class="emoji-btn" onclick="insertEmoji('ğŸ˜Š')">ğŸ˜Š</button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeUpload()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveMemory()">ä¿å­˜å›å¿†</button>
        </div>
    </div>
</div>

<!-- å›å¿†å±•ç¤º -->
<div class="overlay" id="memoryOverlay">
    <div class="modal memory-modal">
        <div class="drag-handle"></div>
        <div class="modal-header">
            <div>
                <div class="modal-title" id="memoryRegionTitle">æ—…è¡Œå›å¿†</div>
                <div class="modal-subtitle" id="memoryCount"></div>
            </div>
            <button class="close-btn" onclick="closeMemory()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="memories-list" id="memoriesList"></div>
        </div>
        <div class="add-memory-bar">
            <button class="btn btn-primary" onclick="openUploadFromMemory()">ï¼‹ æ·»åŠ æ–°å›å¿†</button>
        </div>
    </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close">âœ•</span>
    <img id="lightboxImg" src="" alt="">
</div>

<script>
    var myChart = echarts.init(document.getElementById('map-container'));
    var currentMode = 'china', currentRegion = '', pendingPhotos = [];
    var visitedData = { china: [], world: [] }, memoriesData = {};

    try {
        var s1 = localStorage.getItem('footprint_visited_v6');
        var s2 = localStorage.getItem('footprint_memories_v6');
        if (s1) visitedData = JSON.parse(s1);
        if (s2) memoriesData = JSON.parse(s2);
    } catch(e) {}

    function save() {
        try {
            localStorage.setItem('footprint_visited_v6', JSON.stringify(visitedData));
            localStorage.setItem('footprint_memories_v6', JSON.stringify(memoriesData));
        } catch(e) { alert('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†éƒ¨åˆ†ç…§ç‰‡åé‡è¯•ã€‚'); }
    }

    function memKey(mode, region) { return mode + '|' + region; }

    // â”€â”€ MAP â”€â”€
    function initMap(mapType) {
        currentMode = mapType;
        document.getElementById('btn-china').className = mapType === 'china' ? 'active' : '';
        document.getElementById('btn-world').className  = mapType === 'world'  ? 'active' : '';

        var dataList = visitedData[mapType].map(function(n) { return { name: n, value: 1 }; });

        myChart.setOption({
            backgroundColor: '#F0F5FA',
            tooltip: { show: false },
            visualMap: {
                show: false, min: 0, max: 1,
                pieces: [{ value: 1, color: '#3A87C8' }],
                outOfRange: { color: '#EEEEEE' }
            },
            series: [{
                type: 'map', map: mapType, roam: true, zoom: 1.2,
                itemStyle: { areaColor: '#EEEEEE', borderColor: '#C5D9E8', borderWidth: 0.5 },
                emphasis: {
                    itemStyle: { areaColor: '#C9E4F8' },
                    label: { show: true, color: '#1E2D3D', fontSize: 12, fontFamily: 'Noto Sans SC,sans-serif' }
                },
                select: { itemStyle: { areaColor: '#3A87C8' }, label: { show: false } },
                data: dataList,
                nameMap: mapType === 'world' ? { 'United States': 'United States of America' } : {}
            }]
        }, true);

        updateCount();
        myChart.off('click'); myChart.off('mouseover'); myChart.off('mouseout');

        var tip = document.getElementById('regionTooltip');
        myChart.on('mouseover', function(p) {
            if (!p.name) return;
            tip.textContent = p.name;
            tip.style.display = 'block';
            if (window.innerWidth < 600) {
                clearTimeout(tip._t);
                tip._t = setTimeout(function() { tip.style.display = 'none'; }, 1500);
            }
        });
        myChart.on('mouseout', function() {
            if (window.innerWidth >= 600) tip.style.display = 'none';
        });
        document.getElementById('map-container').addEventListener('mousemove', function(e) {
            if (window.innerWidth >= 600) {
                tip.style.left = (e.clientX + 14) + 'px';
                tip.style.top  = (e.clientY - 30) + 'px';
            }
        });

        myChart.on('click', function(params) {
            if (!params.name) return;
            var name = params.name;
            if (visitedData[currentMode].indexOf(name) > -1) {
                openMemoryViewer(name);
            } else {
                visitedData[currentMode].push(name);
                save(); initMap(currentMode);
                setTimeout(function() { openUpload(name); }, 100);
            }
        });
    }

    function updateCount() {
        document.getElementById('count').innerText = visitedData[currentMode].length;
    }

    function clearData() {
        if (!confirm('ç¡®å®šæ¸…ç©ºå½“å‰è§†å›¾çš„æ‰€æœ‰è®°å½•ï¼Ÿ')) return;
        visitedData[currentMode].forEach(function(n) { delete memoriesData[memKey(currentMode, n)]; });
        visitedData[currentMode] = [];
        save(); initMap(currentMode);
    }

    function saveMapImage() {
        var url = myChart.getDataURL({ type: 'png', pixelRatio: 2, backgroundColor: '#F0F5FA' });
        var a = document.createElement('a');
        a.download = 'æˆ‘çš„è¶³è¿¹_' + currentMode + '.png';
        a.href = url;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    // â”€â”€ UPLOAD â”€â”€
    function openUpload(regionName) {
        currentRegion = regionName; pendingPhotos = [];
        document.getElementById('uploadRegionName').textContent = regionName;
        document.getElementById('travelDate').value = todayStr();
        document.getElementById('travelNote').value = '';
        updateCharCount(); renderPhotoGrid();
        document.getElementById('uploadOverlay').classList.add('active');
    }
    function openUploadFromMemory() {
        closeMemory();
        setTimeout(function() { openUpload(currentRegion); }, 180);
    }
    function closeUpload() {
        document.getElementById('uploadOverlay').classList.remove('active');
        pendingPhotos = [];
    }
    function todayStr() {
        var d = new Date();
        return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }

    function renderPhotoGrid() {
        var grid = document.getElementById('photoGrid');
        grid.innerHTML = '';
        for (var i = 0; i < 9; i++) {
            var slot = document.createElement('div');
            slot.className = 'photo-slot' + (i < pendingPhotos.length ? ' filled' : '');
            if (i < pendingPhotos.length) {
                var img = document.createElement('img'); img.src = pendingPhotos[i];
                slot.appendChild(img);
                var rm = document.createElement('button'); rm.className = 'remove-photo'; rm.innerHTML = 'âœ•';
                var idx = i;
                rm.onclick = function(e) { e.stopPropagation(); removePhoto(idx); };
                slot.appendChild(rm);
            } else if (i === pendingPhotos.length) {
                var icon = document.createElement('span'); icon.className = 'add-icon'; icon.innerHTML = 'ï¼‹';
                slot.appendChild(icon);
                slot.onclick = function() { document.getElementById('photoInput').click(); };
            } else {
                slot.style.opacity = '0.25'; slot.style.pointerEvents = 'none';
            }
            grid.appendChild(slot);
        }
    }

    function removePhoto(idx) { pendingPhotos.splice(idx, 1); renderPhotoGrid(); }

    function handlePhotoSelect(e) {
        var files = Array.from(e.target.files).slice(0, 9 - pendingPhotos.length);
        var done = 0;
        if (files.length === 0) return;
        files.forEach(function(f) {
            if (f.size > 5*1024*1024) { alert(f.name + ' è¶…è¿‡5MBï¼Œå·²è·³è¿‡'); done++; if(done===files.length) renderPhotoGrid(); return; }
            var r = new FileReader();
            r.onload = function(ev) { pendingPhotos.push(ev.target.result); done++; if(done===files.length) renderPhotoGrid(); };
            r.readAsDataURL(f);
        });
        e.target.value = '';
    }

    function updateCharCount() {
        document.getElementById('charCount').textContent = document.getElementById('travelNote').value.length;
    }

    function insertEmoji(em) {
        var ta = document.getElementById('travelNote');
        var c = ta.selectionStart, t = ta.value;
        if (t.length >= 100) return;
        ta.value = t.slice(0,c) + em + t.slice(c);
        ta.selectionStart = ta.selectionEnd = c + em.length;
        updateCharCount(); ta.focus();
    }

    function saveMemory() {
        if (pendingPhotos.length === 0) { alert('è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ æ—…è¡Œç…§ç‰‡~'); return; }
        var date = document.getElementById('travelDate').value;
        if (!date) { alert('è¯·é€‰æ‹©æ—…è¡Œæ—¶é—´~'); return; }
        var key = memKey(currentMode, currentRegion);
        if (!memoriesData[key]) memoriesData[key] = [];
        memoriesData[key].push({ date: date, photos: pendingPhotos.slice(), note: document.getElementById('travelNote').value.trim() });
        memoriesData[key].sort(function(a,b) { return b.date.localeCompare(a.date); });
        save(); closeUpload();
        setTimeout(function() { openMemoryViewer(currentRegion); }, 220);
    }

    // â”€â”€ MEMORY VIEWER â”€â”€
    function openMemoryViewer(regionName) {
        currentRegion = regionName;
        var key = memKey(currentMode, regionName);
        var mems = memoriesData[key] || [];
        document.getElementById('memoryRegionTitle').textContent = 'ğŸ“ ' + regionName;
        document.getElementById('memoryCount').textContent = mems.length + ' æ®µæ—…è¡Œå›å¿†';
        var list = document.getElementById('memoriesList');
        list.innerHTML = '';
        if (mems.length === 0) {
            list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“·</div><p>è¿˜æ²¡æœ‰å›å¿†ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ å§~</p></div>';
        } else {
            mems.forEach(function(mem, idx) {
                var card = document.createElement('div'); card.className = 'memory-card';
                var dateStr = mem.date.replace(/-/g, ' Â· ');
                var photosHtml = '';
                if (mem.photos && mem.photos.length) {
                    photosHtml = '<div class="memory-photos">';
                    mem.photos.forEach(function(src) {
                        photosHtml += '<img src="' + src + '" onclick="openLightbox(\'' + src.replace(/\\/g,'\\\\').replace(/'/g,"\\'") + '\')">';
                    });
                    photosHtml += '</div>';
                }
                var noteHtml = mem.note ? '<div class="memory-note">' + esc(mem.note) + '</div>' : '';
                card.innerHTML =
                    '<div class="memory-card-header">' +
                        '<div class="memory-date">' + dateStr + '</div>' +
                        '<button class="memory-action-btn del" onclick="deleteMemory(\'' + esc(currentMode) + '\',\'' + esc(regionName) + '\',' + idx + ')">åˆ é™¤</button>' +
                    '</div>' + photosHtml + noteHtml;
                list.appendChild(card);
            });
        }
        document.getElementById('memoryOverlay').classList.add('active');
    }

    function closeMemory() { document.getElementById('memoryOverlay').classList.remove('active'); }

    function deleteMemory(mode, region, idx) {
        if (!confirm('ç¡®å®šåˆ é™¤è¿™æ®µå›å¿†å—ï¼Ÿ')) return;
        var key = memKey(mode, region);
        if (memoriesData[key]) {
            memoriesData[key].splice(idx, 1);
            if (!memoriesData[key].length) delete memoriesData[key];
            save(); openMemoryViewer(region);
        }
    }

    function esc(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // â”€â”€ LIGHTBOX â”€â”€
    function openLightbox(src) { document.getElementById('lightboxImg').src = src; document.getElementById('lightbox').classList.add('active'); }
    function closeLightbox() { document.getElementById('lightbox').classList.remove('active'); }

    document.getElementById('uploadOverlay').addEventListener('click', function(e) { if(e.target===this) closeUpload(); });
    document.getElementById('memoryOverlay').addEventListener('click', function(e) { if(e.target===this) closeMemory(); });
    document.addEventListener('keydown', function(e) { if(e.key==='Escape') { closeLightbox(); closeUpload(); closeMemory(); } });
    window.addEventListener('resize', function() { myChart.resize(); });

    initMap('china');
</script>
</body>
</html>

