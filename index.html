<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…è¡Œè¶³è¿¹ - ç‚¹äº®åœ°å›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', sans-serif; background-color: #f5f7fa; color: #333; }
        
        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .header {
            background: #ffffff;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: relative;
            z-index: 10;
        }
        
        h1 { margin: 0 0 15px 0; font-size: 24px; color: #2c3e50; }
        
        .controls button {
            padding: 8px 20px;
            margin: 0 5px;
            border: 1px solid #409eff;
            background: #fff;
            color: #409eff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .controls button:hover { background: #ecf5ff; }
        .controls button.active { background: #409eff; color: #fff; box-shadow: 0 2px 6px rgba(64, 158, 255, 0.4); }
        
        .stats { margin-top: 15px; font-size: 14px; color: #666; }
        .stats span { font-weight: bold; color: #f56c6c; font-size: 18px; margin: 0 3px; }

        /* åœ°å›¾å®¹å™¨ */
        #map-container {
            width: 100%;
            height: calc(100vh - 140px); /* å‡å»å¤´éƒ¨é«˜åº¦ */
            min-height: 500px;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 999;
            display: none; /* é»˜è®¤éšè— */
        }
        
        /* å¯¼å‡ºæŒ‰é’® */
        .export-btn {
            margin-top: 10px;
            font-size: 12px;
            text-decoration: underline;
            color: #909399;
            cursor: pointer;
            border: none;
            background: none;
        }
    </style>
</head>
<body>

<div id="loading" class="loading-mask">æ­£åœ¨åŠ è½½åœ°å›¾æ•°æ®...</div>

<div class="header">
    <h1>ğŸŒ æˆ‘çš„è¶³è¿¹åœ°å›¾</h1>
    <div class="controls">
        <button id="btn-china" onclick="initMap('china')">ğŸ‡¨ğŸ‡³ å›½å†…ç‰ˆ (ç²¾ç¡®åˆ°å¸‚)</button>
        <button id="btn-world" onclick="initMap('world')">ğŸŒ å›½é™…ç‰ˆ (ç²¾ç¡®åˆ°å›½å®¶)</button>
    </div>
    <div class="stats">
        å·²ç‚¹äº®: <span id="visit-count">0</span> ä¸ªåŒºåŸŸ
        <br>
        <button class="export-btn" onclick="exportImage()">ğŸ“· ä¿å­˜ä¸ºå›¾ç‰‡</button>
        <button class="export-btn" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
    </div>
</div>

<div id="map-container"></div>

<script>
    // --- é…ç½®åŒº ---
    const CONFIG = {
        // ä¸­å›½åœ°å›¾æ•°æ®æº (é˜¿é‡Œäº‘ DataV, æå…¶ç¨³å®š)
        chinaUrl: 'https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json',
        // ä¸–ç•Œåœ°å›¾æ•°æ®æº (ä½¿ç”¨å¼€æº GeoJSON)
        worldUrl: 'https://code.highcharts.com/mapdata/custom/world.topo.json' 
    };

    // --- å…¨å±€å˜é‡ ---
    let myChart = null;
    let currentMode = 'china'; // 'china' or 'world'
    // å­˜å‚¨å»è¿‡çš„åœ°æ–¹ï¼š { china: ['åŒ—äº¬å¸‚', 'ä¸Šæµ·å¸‚'], world: ['China', 'Japan'] }
    let visitedData = { china: [], world: [] };

    // --- åˆå§‹åŒ–é€»è¾‘ ---
    
    // 1. è¯»å–æœ¬åœ°å­˜å‚¨
    function loadSavedData() {
        const saved = localStorage.getItem('my_footprint_data');
        if (saved) {
            visitedData = JSON.parse(saved);
        }
    }

    // 2. æ ¸å¿ƒï¼šåŠ è½½å¹¶æ¸²æŸ“åœ°å›¾
    async function initMap(type) {
        currentMode = type;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active'));
        document.getElementById(type === 'china' ? 'btn-china' : 'btn-world').classList.add('active');
        
        // æ˜¾ç¤ºåŠ è½½ä¸­
        document.getElementById('loading').style.display = 'flex';

        // åˆå§‹åŒ– ECharts å®ä¾‹
        if (myChart) myChart.dispose();
        myChart = echarts.init(document.getElementById('map-container'));
        
        myChart.showLoading();

        try {
            let geoJson;
            let mapName = type;

            if (type === 'china') {
                const response = await fetch(CONFIG.chinaUrl);
                geoJson = await response.json();
            } else {
                // ä¸–ç•Œåœ°å›¾å¤„ç†
                const response = await fetch(CONFIG.worldUrl);
                geoJson = await response.json();
                // æ³¨æ„ï¼šHighcharts çš„ world.topo.json æ˜¯ TopoJSON æ ¼å¼ï¼ŒECharts ä¸æ”¯æŒç›´æ¥ç”¨ GeoJSON æ³¨å†Œ TopoJSON
                // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ fetch åå¦‚æœå‘ç°æ˜¯ TopoJSON éœ€è¦è½¬æ¢ï¼Œæˆ–è€…ç›´æ¥å¯»æ‰¾ GeoJSON æºã€‚
                // *ä¸ºäº†ä¿è¯æ¼”ç¤ºæˆåŠŸï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨ fetch ä¸€ä¸ªæ ‡å‡†çš„ GeoJSON é“¾æ¥*
                const worldRes = await fetch('https://raw.githubusercontent.com/apache/echarts-examples/gh-pages/public/data/asset/geo/world.json');
                geoJson = await worldRes.json();
            }

            // æ³¨å†Œåœ°å›¾
            echarts.registerMap(mapName, geoJson);
            
            // æ¸²æŸ“é…ç½®
            renderChart(mapName);
            
            document.getElementById('loading').style.display = 'none';
            myChart.hideLoading();

        } catch (error) {
            console.error(error);
            alert('åœ°å›¾æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ (éƒ¨åˆ†æ•°æ®æºå¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘)');
            document.getElementById('loading').style.display = 'none';
            myChart.hideLoading();
        }
    }

    // 3. æ¸²æŸ“å›¾è¡¨é…ç½®
    function renderChart(mapName) {
        // å‡†å¤‡é«˜äº®æ•°æ®
        const dataList = visitedData[currentMode].map(name => {
            return { name: name, value: 1 };
        });

        const option = {
            backgroundColor: '#f5f7fa',
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    return params.name + (visitedData[currentMode].includes(params.name) ? ' (å·²æ‰“å¡ âœ…)' : '');
                }
            },
            // è§†è§‰æ˜ å°„ç»„ä»¶ (æ§åˆ¶é¢œè‰²)
            visualMap: {
                show: false,
                min: 0,
                max: 1,
                inRange: {
                    color: ['#e0e4eb', '#f56c6c'] // [æœªå»è¿‡é¢œè‰², å»è¿‡é¢œè‰²]
                }
            },
            geo: {
                map: mapName,
                roam: true, // å¼€å¯ç¼©æ”¾å’Œå¹³ç§»
                zoom: 1.2,
                label: {
                    show: currentMode === 'china', // å›½å†…æ˜¾ç¤ºæ–‡å­—ï¼Œä¸–ç•Œåœ°å›¾å¤ªå¯†æš‚æ—¶ä¸æ˜¾ç¤º
                    fontSize: 10,
                    color: 'rgba(0,0,0,0.7)'
                },
                itemStyle: {
                    areaColor: '#e0e4eb',
                    borderColor: '#ffffff',
                    borderWidth: 1
                },
                emphasis: { // é¼ æ ‡æ‚¬åœæ ·å¼
                    itemStyle: {
                        areaColor: '#ffd04b'
                    },
                    label: { show: true }
                }
            },
            series: [
                {
                    name: 'è¶³è¿¹',
                    type: 'map',
                    geoIndex: 0,
                    data: dataList
                }
            ]
        };

        myChart.setOption(option);
        updateStats();

        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        myChart.off('click');
        myChart.on('click', function (params) {
            toggleVisit(params.name);
        });
    }

    // 4. ç‚¹å‡»äº¤äº’é€»è¾‘
    function toggleVisit(name) {
        if (!name) return;

        const list = visitedData[currentMode];
        const index = list.indexOf(name);

        if (index > -1) {
            // å·²å­˜åœ¨ï¼Œåˆ é™¤ (å–æ¶ˆæ‰“å¡)
            list.splice(index, 1);
        } else {
            // ä¸å­˜åœ¨ï¼Œæ·»åŠ  (æ‰“å¡)
            list.push(name);
        }

        // ä¿å­˜å¹¶é‡ç»˜
        saveData();
        renderChart(currentMode);
    }

    // 5. ä¿å­˜æ•°æ®åˆ° localStorage
    function saveData() {
        localStorage.setItem('my_footprint_data', JSON.stringify(visitedData));
    }
    
    // 6. æ¸…ç©ºæ•°æ®
    function clearData() {
        if(confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰åœ°å›¾çš„æ‰€æœ‰è®°å½•å—ï¼Ÿ')) {
            visitedData[currentMode] = [];
            saveData();
            renderChart(currentMode);
        }
    }

    // 7. æ›´æ–°ç»Ÿè®¡
    function updateStats() {
        document.getElementById('visit-count').innerText = visitedData[currentMode].length;
    }

    // 8. å¯¼å‡ºå›¾ç‰‡
    function exportImage() {
        const url = myChart.getDataURL({
            type: 'png',
            backgroundColor: '#fff'
        });
        const a = document.createElement('a');
        a.href = url;
        a.download = 'æˆ‘çš„è¶³è¿¹åœ°å›¾.png';
        a.click();
    }

    // 9. çª—å£å¤§å°è‡ªé€‚åº”
    window.addEventListener('resize', () => {
        if (myChart) myChart.resize();
    });

    // å¯åŠ¨ç¨‹åº
    loadSavedData();
    // é»˜è®¤åŠ è½½å›½å†…åœ°å›¾
    initMap('china');

</script>
</body>
</html>
