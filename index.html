<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…è¡Œè¶³è¿¹</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f5f5f5; display: flex; flex-direction: column; align-items: center; }
        
        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        header { background-color: #2c3e50; color: white; width: 100%; padding: 15px 0; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.2rem; font-weight: normal; }

        /* æŒ‰é’®åŒºåŸŸ */
        .controls { margin: 20px 0; display: flex; gap: 15px; }
        button { padding: 8px 20px; font-size: 14px; cursor: pointer; border: none; border-radius: 20px; background-color: #fff; border: 1px solid #ddd; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        button.active { background-color: #3498db; color: white; border-color: #3498db; }

        /* åœ°å›¾å®¹å™¨ */
        #map-container { 
            width: 95%; 
            max-width: 1000px;
            height: 65vh; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); 
            margin-bottom: 20px; 
            position: relative;
            overflow: hidden;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats { font-size: 16px; color: #666; margin-bottom: 10px; font-weight: bold; }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #999; pointer-events: none; }
    </style>
</head>
<body>

<header>
    <h1>âœˆï¸ æˆ‘çš„è¶³è¿¹åœ°å›¾</h1>
</header>

<div class="controls">
    <button id="btn-china" class="active" onclick="switchMap('china')">ğŸ‡¨ğŸ‡³ å›½å†…è¶³è¿¹</button>
    <button id="btn-world" onclick="switchMap('world')">ğŸŒ å›½é™…è¶³è¿¹</button>
</div>

<div class="stats" id="stats-display">ç»Ÿè®¡ä¸­...</div>

<div id="map-container">
    <div id="loading-text" class="loading">åœ°å›¾èµ„æºåŠ è½½ä¸­...</div>
</div>

<script>
    const myChart = echarts.init(document.getElementById('map-container'));
    
    // --- æ ¸å¿ƒé…ç½®ï¼šä½¿ç”¨ jsDelivr åŠ è½½ GitHub ä¸Šç¨³å®šçš„ GeoJSON æ•°æ® ---
    // æ¥æºï¼šECharts å®˜æ–¹å¼€å‘è€… pissang çš„ä»“åº“ï¼Œéå¸¸ç¨³å®š
    const MAP_URLS = {
        china: 'https://cdn.jsdelivr.net/gh/pissang/echarts-map/json/china.json',
        world: 'https://cdn.jsdelivr.net/gh/pissang/echarts-map/json/world.json'
    };

    let currentMap = 'china';
    let visitedData = {
        china: JSON.parse(localStorage.getItem('visited_china_v2')) || [],
        world: JSON.parse(localStorage.getItem('visited_world_v2')) || []
    };

    // æ¸²æŸ“å‡½æ•°
    async function renderMap(mapType) {
        // 1. UI æ›´æ–°
        document.getElementById('btn-china').className = mapType === 'china' ? 'active' : '';
        document.getElementById('btn-world').className = mapType === 'world' ? 'active' : '';
        document.getElementById('loading-text').style.display = 'block';
        
        try {
            // 2. æ£€æŸ¥å¹¶åŠ è½½åœ°å›¾æ•°æ®
            if (!echarts.getMap(mapType)) {
                const response = await fetch(MAP_URLS[mapType]);
                if (!response.ok) throw new Error('ç½‘ç»œé”™è¯¯');
                const geoJson = await response.json();
                echarts.registerMap(mapType, geoJson);
            }

            // 3. å‡†å¤‡æ•°æ®
            document.getElementById('loading-text').style.display = 'none';
            currentMap = mapType;
            updateStats();

            const data = visitedData[mapType].map(name => ({ name: name, value: 1 }));

            // 4. ECharts é…ç½®
            const option = {
                // å³ä¸Šè§’ä¿å­˜å›¾ç‰‡æŒ‰é’®
                toolbox: {
                    show: true,
                    feature: {
                        saveAsImage: { show: true, pixelRatio: 2, title: 'ä¿å­˜å›¾ç‰‡' }
                    },
                    right: 20,
                    top: 20
                },
                tooltip: { trigger: 'item', formatter: '{b}' },
                // è§†è§‰æ˜ å°„ï¼ˆå»è¿‡çš„åœ°æ–¹å˜è‰²ï¼‰
                visualMap: {
                    show: false,
                    min: 0, max: 1,
                    inRange: { color: ['#eeeeee', '#ff7675'] } // ç°è‰² -> çº¢è‰²
                },
                geo: {
                    map: mapType,
                    roam: true, // å…è®¸ç¼©æ”¾
                    zoom: 1.2,
                    label: { show: false }, // é»˜è®¤ä¸æ˜¾ç¤ºæ–‡å­—
                    itemStyle: {
                        areaColor: '#eeeeee', // é»˜è®¤é¢œè‰²
                        borderColor: '#999',  // è¾¹æ¡†é¢œè‰²
                        borderWidth: 0.5
                    },
                    emphasis: { // é¼ æ ‡æ‚¬åœ
                        itemStyle: { areaColor: '#ffeaa7' },
                        label: { show: true }
                    }
                },
                series: [{
                    type: 'map',
                    geoIndex: 0,
                    data: data
                }]
            };

            myChart.setOption(option, true);

        } catch (error) {
            console.error(error);
            document.getElementById('loading-text').innerText = "åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°ç½‘é¡µé‡è¯•";
        }
    }

    // æ›´æ–°ç»Ÿè®¡æ–‡å­—
    function updateStats() {
        const count = visitedData[currentMap].length;
        const region = currentMap === 'china' ? 'ä¸ªçœä»½' : 'ä¸ªå›½å®¶';
        document.getElementById('stats-display').innerText = `å·²ç‚¹äº® ${count} ${region}`;
    }

    // ç‚¹å‡»äº¤äº’ï¼ˆæ‰“å¡/å–æ¶ˆï¼‰
    myChart.on('click', function (params) {
        if (!params.name) return;
        const name = params.name;
        const list = visitedData[currentMap];
        const index = list.indexOf(name);

        if (index > -1) {
            list.splice(index, 1); // å–æ¶ˆ
        } else {
            list.push(name); // æ‰“å¡
        }

        // ä¿å­˜å¹¶åˆ·æ–°
        localStorage.setItem(`visited_${currentMap}_v2`, JSON.stringify(list));
        updateStats();
        
        myChart.setOption({
            series: [{ data: list.map(n => ({ name: n, value: 1 })) }]
        });
    });

    // åˆ‡æ¢åœ°å›¾
    window.switchMap = function(type) {
        renderMap(type);
    }

    // çª—å£è°ƒæ•´
    window.addEventListener('resize', () => myChart.resize());

    // ğŸš€ å¯åŠ¨ï¼
    renderMap('china');

</script>
</body>
</html>
