<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è¶³è¿¹åœ°å›¾</title>
    <script src="https://lib.baomitu.com/echarts/5.4.3/echarts.min.js"></script>
    <style>
        body { margin: 0; background: #f0f2f5; font-family: "Microsoft YaHei", sans-serif; display: flex; flex-direction: column; align-items: center; }
        header { background: #333; color: white; width: 100%; padding: 10px 0; text-align: center; }
        
        .controls { margin: 20px; display: flex; gap: 15px; }
        button { padding: 8px 20px; cursor: pointer; border: none; background: white; border: 1px solid #ccc; border-radius: 4px; }
        button.active { background: #1890ff; color: white; border-color: #1890ff; }
        
        #map-box { 
            width: 95%; max-width: 1000px; height: 70vh; 
            background: white; border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            position: relative;
        }
        
        .info-panel { text-align: center; margin-bottom: 10px; color: #555; }
        .num { color: #1890ff; font-weight: bold; font-size: 1.2em; }

        /* é”™è¯¯æç¤ºæ¡† */
        #error-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: red; background: #fff0f0; padding: 20px; display: none; border: 1px solid red; z-index: 999;
        }
        #loading-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #888; pointer-events: none;
        }
    </style>
</head>
<body>

<header><h1>âœˆï¸ æˆ‘çš„æ—…è¡Œè¶³è¿¹</h1></header>

<div class="controls">
    <button id="btn-china" onclick="loadMap('china')" class="active">ğŸ‡¨ğŸ‡³ ä¸­å›½</button>
    <button id="btn-world" onclick="loadMap('world')">ğŸŒ ä¸–ç•Œ</button>
</div>

<div class="info-panel">
    å·²ç‚¹äº® <span id="count" class="num">0</span> ä¸ªåŒºåŸŸ
</div>

<div id="map-box">
    <div id="loading-msg">æ­£åœ¨ä»å›½å†…é•œåƒåŠ è½½åœ°å›¾...</div>
    <div id="error-msg"></div>
</div>

<script>
    const chart = echarts.init(document.getElementById('map-box'));
    let currentMap = 'china';
    
    // è¯»å–æœ¬åœ°å­˜å‚¨
    let dataStore = {
        china: JSON.parse(localStorage.getItem('v_china') || '[]'),
        world: JSON.parse(localStorage.getItem('v_world') || '[]')
    };

    // ğŸ› ï¸ æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ 360 (Baomitu) çš„ CDNï¼Œå›½å†…é€Ÿåº¦æå¿«ï¼Œä¸”ç¨³å®š
    const MAP_SOURCES = {
        // æ³¨æ„ï¼šè¿™é‡Œç›´æ¥åŠ è½½ JS æ–‡ä»¶ï¼Œæ¯”åŠ è½½ JSON æ›´ç¨³å®š
        china: 'https://lib.baomitu.com/echarts/4.9.0-rc.1/map/js/china.js',
        world: 'https://lib.baomitu.com/echarts/4.9.0-rc.1/map/js/world.js'
    };

    // åŠ¨æ€åŠ è½½ Script æ ‡ç­¾
    function loadScript(url, callback) {
        const script = document.createElement('script');
        script.src = url;
        script.onload = callback;
        script.onerror = () => {
            document.getElementById('loading-msg').style.display = 'none';
            document.getElementById('error-msg').style.display = 'block';
            document.getElementById('error-msg').innerHTML = `
                åœ°å›¾åŠ è½½å¤±è´¥ï¼<br>è¯·å°è¯•ï¼š<br>1. åˆ·æ–°ç½‘é¡µ<br>2. åˆ‡æ¢æ‰‹æœº/Wi-Fiç½‘ç»œ`;
        };
        document.head.appendChild(script);
    }

    function render() {
        document.getElementById('loading-msg').style.display = 'none';
        document.getElementById('error-msg').style.display = 'none';
        
        // æ›´æ–°ç»Ÿè®¡
        const list = dataStore[currentMap];
        document.getElementById('count').innerText = list.length;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.getElementById('btn-china').className = currentMap === 'china' ? 'active' : '';
        document.getElementById('btn-world').className = currentMap === 'world' ? 'active' : '';

        const option = {
            tooltip: { trigger: 'item', formatter: '{b}' },
            toolbox: {
                feature: { saveAsImage: { title: 'ä¿å­˜å›¾ç‰‡' } },
                right: 20
            },
            geo: {
                map: currentMap,
                roam: true,
                zoom: 1.2,
                label: { show: false },
                itemStyle: {
                    areaColor: '#f5f5f5',
                    borderColor: '#999',
                    borderWidth: 0.5
                },
                emphasis: {
                    itemStyle: { areaColor: '#ffeaa7' },
                    label: { show: true }
                }
            },
            series: [{
                type: 'map',
                geoIndex: 0,
                data: list.map(name => ({ name: name, value: 1 }))
            }],
            visualMap: {
                show: false,
                min: 0, max: 1,
                inRange: { color: ['#f5f5f5', '#ff4757'] }
            }
        };
        chart.setOption(option, true);
    }

    // ç‚¹å‡»äº¤äº’
    chart.on('click', params => {
        if (!params.name) return;
        const name = params.name;
        const list = dataStore[currentMap];
        const idx = list.indexOf(name);
        
        if (idx >= 0) list.splice(idx, 1);
        else list.push(name);
        
        localStorage.setItem('v_' + currentMap, JSON.stringify(list));
        render();
    });

    // åˆ‡æ¢åœ°å›¾é€»è¾‘
    window.loadMap = function(type) {
        currentMap = type;
        document.getElementById('loading-msg').style.display = 'block';
        
        // å¦‚æœ ECharts é‡Œå·²ç»æœ‰è¿™ä¸ªåœ°å›¾äº†ï¼Œç›´æ¥æ¸²æŸ“
        if (echarts.getMap(type)) {
            render();
            return;
        }

        // å¦åˆ™å»ä¸‹è½½
        loadScript(MAP_SOURCES[type], () => {
            render();
        });
    };

    window.onresize = () => chart.resize();

    // å¯åŠ¨
    loadMap('china');
</script>
</body>
</html>
