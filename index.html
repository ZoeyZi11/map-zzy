<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…è¡Œè¶³è¿¹ - My Footprints</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            background-color: #333;
            color: white;
            width: 100%;
            padding: 1rem 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .controls {
            margin: 20px 0;
            display: flex;
            gap: 20px;
        }

        button {
            padding: 10px 25px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 20px;
            background-color: #e0e0e0;
            transition: all 0.3s;
        }

        button.active {
            background-color: #1890ff;
            color: white;
            box-shadow: 0 4px 10px rgba(24, 144, 255, 0.4);
        }

        #map-container {
            width: 90%;
            height: 70vh;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .stats {
            font-size: 18px;
            color: #555;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<header>
    <h1>ğŸŒ æˆ‘çš„è¶³è¿¹åœ°å›¾</h1>
</header>

<div class="controls">
    <button id="btn-china" class="active" onclick="switchMap('china')">ğŸ‡¨ğŸ‡³ å›½å†…è¶³è¿¹ (China)</button>
    <button id="btn-world" onclick="switchMap('world')">ğŸŒ å›½é™…è¶³è¿¹ (World)</button>
</div>

<div class="stats" id="stats-display">
    å·²æ‰“å¡: 0 ä¸ªåŒºåŸŸ
</div>

<div id="map-container"></div>

<script>
    // 1. åˆå§‹åŒ– ECharts å®ä¾‹
    const myChart = echarts.init(document.getElementById('map-container'));
    
    // çŠ¶æ€ç®¡ç†
    let currentMap = 'china'; // 'china' or 'world'
    // ä» localStorage è¯»å–è®°å½•ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
    let visitedData = {
        china: JSON.parse(localStorage.getItem('visited_china')) || [],
        world: JSON.parse(localStorage.getItem('visited_world')) || []
    };

    // åœ°å›¾ GeoJSON æ•°æ®çš„ URL (ä½¿ç”¨å…¬å…± CDN)
    const MAP_URLS = {
        china: 'https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json', // é˜¿é‡Œäº‘ DataV æä¾›çš„ä¸­å›½æ•°æ®
        world: 'https://code.highcharts.com/mapdata/custom/world.geo.json'      // Highcharts æä¾›çš„ä¸–ç•Œæ•°æ®
    };

    // 2. é…ç½®é¡¹ç”Ÿæˆå‡½æ•°
    function getOption(mapName, visitedList) {
        // æ„å»ºæ•°æ®æ ¼å¼ï¼š[{name: 'åŒ—äº¬', value: 1}, ...]
        const dataSeries = visitedList.map(name => ({ name: name, value: 1 }));

        return {
            tooltip: {
                trigger: 'item',
                formatter: '{b}'
            },
            visualMap: {
                show: false,
                min: 0,
                max: 1,
                inRange: {
                    color: ['#e0e0e0', '#ff6b6b'] // æœªå»è¿‡æ˜¯ç°è‰²ï¼Œå»è¿‡æ˜¯çº¢è‰²
                }
            },
            geo: {
                map: mapName,
                roam: true, // å…è®¸ç¼©æ”¾å’Œå¹³ç§»
                label: {
                    show: false // é»˜è®¤ä¸æ˜¾ç¤ºæ–‡å­—ï¼Œé¿å…æ‹¥æŒ¤ï¼Œé¼ æ ‡æ”¾ä¸Šå»ä¼šæœ‰æç¤º
                },
                itemStyle: {
                    areaColor: '#e0e0e0',
                    borderColor: '#fff',
                    borderWidth: 1
                },
                emphasis: { // é¼ æ ‡æ‚¬åœæ ·å¼
                    itemStyle: {
                        areaColor: '#ffd966'
                    },
                    label: {
                        show: true
                    }
                }
            },
            series: [
                {
                    name: 'è¶³è¿¹',
                    type: 'map',
                    geoIndex: 0,
                    data: dataSeries // åŠ è½½å·²å»è¿‡çš„æ•°æ®
                }
            ]
        };
    }

    // 3. æ¸²æŸ“åœ°å›¾çš„ä¸»å‡½æ•°
    async function renderMap(mapType) {
        myChart.showLoading();
        
        try {
            // å¦‚æœåœ°å›¾æ•°æ®è¿˜æ²¡æ³¨å†Œè¿‡ï¼Œå…ˆ fetch ä¸‹æ¥
            if (!echarts.getMap(mapType)) {
                const response = await fetch(MAP_URLS[mapType]);
                const geoJson = await response.json();
                
                // æ³¨å†Œåœ°å›¾
                echarts.registerMap(mapType, geoJson);
            }

            // æ›´æ–° UI æŒ‰é’®çŠ¶æ€
            document.getElementById('btn-china').className = mapType === 'china' ? 'active' : '';
            document.getElementById('btn-world').className = mapType === 'world' ? 'active' : '';
            
            // æ›´æ–°ç»Ÿè®¡
            updateStats();

            // è®¾ç½® ECharts é€‰é¡¹
            const option = getOption(mapType, visitedData[mapType]);
            myChart.setOption(option, true); // true è¡¨ç¤ºä¸åˆå¹¶ï¼Œå®Œå…¨é‡ç»˜
            
        } catch (error) {
            console.error('åœ°å›¾åŠ è½½å¤±è´¥:', error);
            alert('åœ°å›¾æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        } finally {
            myChart.hideLoading();
        }
    }

    // 4. æ›´æ–°ç»Ÿè®¡æ–‡æ¡ˆ
    function updateStats() {
        const count = visitedData[currentMap].length;
        const unit = currentMap === 'china' ? 'ä¸ªçœ/ç›´è¾–å¸‚' : 'ä¸ªå›½å®¶/åœ°åŒº';
        document.getElementById('stats-display').innerText = `å·²æ‰“å¡: ${count} ${unit}`;
    }

    // 5. ç‚¹å‡»äº¤äº’é€»è¾‘
    myChart.on('click', function (params) {
        if (!params.name) return;

        const regionName = params.name;
        const list = visitedData[currentMap];
        const index = list.indexOf(regionName);

        if (index > -1) {
            // å¦‚æœå·²ç»å­˜åœ¨ï¼Œåˆ™åˆ é™¤ï¼ˆå–æ¶ˆæ‰“å¡ï¼‰
            list.splice(index, 1);
        } else {
            // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ ï¼ˆæ‰“å¡ï¼‰
            list.push(regionName);
        }

        // ä¿å­˜åˆ° localStorage
        localStorage.setItem(`visited_${currentMap}`, JSON.stringify(list));

        // åˆ·æ–°åœ°å›¾æ˜¾ç¤º
        updateStats();
        myChart.setOption({
            series: [{
                data: list.map(name => ({ name: name, value: 1 }))
            }]
        });
    });

    // 6. åˆ‡æ¢åœ°å›¾å‡½æ•°
    function switchMap(type) {
        currentMap = type;
        renderMap(type);
    }

    // çª—å£å¤§å°æ”¹å˜æ—¶è‡ªåŠ¨è°ƒæ•´åœ°å›¾å¤§å°
    window.addEventListener('resize', () => {
        myChart.resize();
    });

    // é¡µé¢åŠ è½½å®Œæˆåé»˜è®¤æ˜¾ç¤ºä¸­å›½åœ°å›¾
    renderMap('china');

</script>
</body>
</html>