<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…è¡Œè¶³è¿¹ - ç®€çº¦ç‰ˆ</title>
    
    <script src="https://assets.pyecharts.org/assets/echarts.min.js"></script>
    <script src="https://assets.pyecharts.org/assets/maps/china.js"></script>
    <script src="https://assets.pyecharts.org/assets/maps/world.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Microsoft YaHei', sans-serif; background-color: #ffffff; }
        
        .header {
            background: #fff; 
            padding: 15px; 
            text-align: center;
            border-bottom: 1px solid #eee;
            position: relative; 
            z-index: 100;
        }
        
        h1 { margin: 0 0 15px 0; font-size: 22px; color: #333; letter-spacing: 1px; }
        
        /* æŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .controls button {
            padding: 8px 24px; 
            margin: 0 5px; 
            cursor: pointer;
            border: 1px solid #333; 
            background: #fff; 
            color: #333; 
            border-radius: 4px; 
            transition: all 0.2s; 
            font-size: 14px;
        }
        .controls button:hover { background: #f5f5f5; }
        .controls button.active { background: #333; color: #fff; }
        
        /* åŠŸèƒ½åŒº */
        .tools { margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 20px; font-size: 14px; color: #666; }
        
        /* ä¿å­˜æŒ‰é’®ç‰¹åˆ«æ ·å¼ */
        .save-btn {
            background-color: #d9534f !important;
            color: white !important;
            border-color: #d9534f !important;
            font-weight: bold;
        }
        .save-btn:hover { background-color: #c9302c !important; }

        #map-container { width: 100%; height: calc(100vh - 150px); }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ—ºï¸ æˆ‘çš„æ—…è¡Œè¶³è¿¹</h1>
    <div class="controls">
        <button id="btn-china" class="active" onclick="initMap('china')">ğŸ‡¨ğŸ‡³ å›½å†…</button>
        <button id="btn-world" onclick="initMap('world')">ğŸŒ ä¸–ç•Œ</button>
    </div>
    <div class="tools">
        <span>å·²ç‚¹äº®: <strong id="count" style="color:#d9534f; font-size:18px;">0</strong> å¤„</span>
        |
        <a href="#" onclick="clearData(); return false;" style="color:#999; text-decoration:none;">æ¸…ç©ºé‡ç½®</a>
        |
        <button class="save-btn" onclick="saveMapImage()">ğŸ“· ä¿å­˜å›¾ç‰‡</button>
    </div>
</div>

<div id="map-container"></div>

<script>
    var myChart = echarts.init(document.getElementById('map-container'));
    var currentMode = 'china';
    var visitedData = { china: [], world: [] };

    // è¯»å–å†å²è®°å½•
    try {
        var saved = localStorage.getItem('my_footprint_v4'); // å‡çº§å­˜å‚¨key
        if (saved) visitedData = JSON.parse(saved);
    } catch(e) {}

    // åˆå§‹åŒ–
    initMap('china');

    function initMap(mapType) {
        currentMode = mapType;
        
        // æ›´æ–°é¡¶éƒ¨æŒ‰é’®çŠ¶æ€
        document.getElementById('btn-china').className = mapType === 'china' ? 'active' : '';
        document.getElementById('btn-world').className = mapType === 'world' ? 'active' : '';

        // å‡†å¤‡æ•°æ®
        var dataList = visitedData[mapType].map(function(name) {
            return { name: name, value: 1 };
        });

        var option = {
            // èƒŒæ™¯è®¾ä¸ºç™½è‰² (å¦‚æœæƒ³è¦å®Œå…¨é€æ˜ï¼Œæ”¹æˆ 'transparent')
            backgroundColor: '#ffffff',
            
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    return params.name + (visitedData[mapType].indexOf(params.name) > -1 ? ' (å·²å»è¿‡)' : '');
                }
            },
            
            geo: {
                map: mapType,
                roam: true, // å…è®¸ç¼©æ”¾
                zoom: 1.2,
                label: {
                    show: mapType === 'china', // åªæœ‰å›½å†…æ˜¾ç¤ºåœ°å
                    color: '#999',
                    fontSize: 10
                },
                // --- æ ¸å¿ƒä¿®æ”¹ï¼šæœªå»è¿‡çš„åœ°æ–¹æ ·å¼ ---
                itemStyle: {
                    areaColor: '#ffffff', // âš ï¸ æ²¡å»è¿‡çš„åœ°æ–¹æ˜¯ç™½è‰²
                    borderColor: '#999',  // è¾¹æ¡†ç°è‰²ï¼Œå‹¾å‹’è½®å»“
                    borderWidth: 1        // è¾¹æ¡†ç²—ç»†
                },
                emphasis: {
                    itemStyle: { areaColor: '#ffe082' }, // é¼ æ ‡æ”¾ä¸Šå»æ˜¯æ·¡é»„è‰²
                    label: { show: true }
                }
            },
            
            series: [{
                type: 'map',
                geoIndex: 0,
                data: dataList,
                // --- æ ¸å¿ƒä¿®æ”¹ï¼šå»è¿‡çš„åœ°æ–¹æ ·å¼ ---
                itemStyle: {
                    areaColor: '#ff5252', // âš ï¸ å»è¿‡çš„åœ°æ–¹æ˜¯çº¢è‰² (å¯è‡ªè¡Œä¿®æ”¹é¢œè‰²)
                    borderColor: '#fff',
                    borderWidth: 1
                }
            }]
        };

        // ä¸–ç•Œåœ°å›¾åç§°ä¿®æ­£
        if (mapType === 'world') {
            option.geo.nameMap = { 'United States': 'United States of America' };
        }

        myChart.setOption(option, true);
        updateCount();

        // ç»‘å®šç‚¹å‡»é€»è¾‘
        myChart.off('click');
        myChart.on('click', function(params) {
            if (params.name) {
                toggleVisit(params.name);
            }
        });
    }

    function toggleVisit(name) {
        var list = visitedData[currentMode];
        var index = list.indexOf(name);
        if (index > -1) {
            list.splice(index, 1);
        } else {
            list.push(name);
        }
        localStorage.setItem('my_footprint_v4', JSON.stringify(visitedData));
        initMap(currentMode);
    }

    function updateCount() {
        document.getElementById('count').innerText = visitedData[currentMode].length;
    }
    
    function clearData() {
        if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ')) {
            visitedData[currentMode] = [];
            localStorage.setItem('my_footprint_v4', JSON.stringify(visitedData));
            initMap(currentMode);
        }
    }

    // --- æ–°å¢ï¼šä¸€é”®ä¿å­˜å›¾ç‰‡åŠŸèƒ½ ---
    function saveMapImage() {
        // å¯¼å‡ºå›¾ç‰‡ Base64
        var url = myChart.getDataURL({
            type: 'png',        // æ ¼å¼
            pixelRatio: 2,      // 2å€é«˜æ¸…ï¼Œé˜²æ­¢æ¨¡ç³Š
            backgroundColor: '#fff' // å¯¼å‡ºèƒŒæ™¯è‰²
        });
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        var a = document.createElement('a');
        a.download = 'æˆ‘çš„è¶³è¿¹åœ°å›¾_' + currentMode + '.png'; // æ–‡ä»¶å
        a.href = url;
        
        // è§¦å‘ä¸‹è½½
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    window.onresize = function() { myChart.resize(); };
</script>
</body>
</html>
